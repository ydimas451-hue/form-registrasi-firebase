<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrasi Akun Merbabu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="custom.css">
</head>
<body>

    <header class="bg-primary text-white py-4 mb-4">
        <div class="container text-center">
            <h1 class="fs-4">REGISTRASI MERBABU VIA WEKAS</h1>
            <p class="mb-0">Open Trip GEMPAL !!!</p>
        </div>
    </header>

    <div class="container my-5">
        <div class="card shadow-lg border-0">
            <div class="card-body p-4 p-md-5">
                <form action="#" method="POST" class="needs-validation" novalidate>

                    <div class="mb-4">
                        <label for="kewarganegaraan" class="form-label required">Jenis Kewarganegaraan</label>
                        <select class="form-select" id="kewarganegaraan" name="kewarganegaraan" required>
                            <option value="WNI" selected>WNI</option>
                            <option value="WNA">WNA</option>
                        </select>
                        <div class="invalid-feedback">Pilih jenis kewarganegaraan Anda.</div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-4">
                            <label for="jenis_identitas" class="form-label required">Jenis Identitas</label>
                            <select class="form-select" id="jenis_identitas" name="jenis_identitas" required>
                                <option value="KTP" selected>KTP</option>
                                <option value="Kartu Pelajar">Kartu Pelajar</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="lampiran_ktp" class="form-label required">Lampiran Identitas KTP / Kartu Pelajar</label>
                            <input type="file" class="form-control" id="lampiran_ktp" name="lampiran_ktp" accept=".jpg,.png" required>
                            <div class="form-text">Silahkan lampirkan file gambar berformat .jpg / .png</div>
                            <div class="invalid-feedback">Lampiran identitas diperlukan.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="nomor_ktp" class="form-label required">Nomor KTP / Kartu Pelajar</label>
                            <input type="text" class="form-control" id="nomor_ktp" name="nomor_ktp" required pattern="\d{16}" placeholder="Masukkan 16 digit Nomor KTP">
                            <div class="invalid-feedback">Nomor KTP harus 16 digit angka.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <label for="nama_lengkap" class="form-label required">Nama Lengkap</label>
                            <input type="text" class="form-control" id="nama_lengkap" name="nama_lengkap" required>
                            <div class="invalid-feedback">Nama lengkap wajib diisi.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="tanggal_lahir" class="form-label required">Tanggal Lahir</label>
                            <input type="date" class="form-control" id="tanggal_lahir" name="tanggal_lahir" required>
                            <div class="invalid-feedback">Tanggal lahir wajib diisi.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-4">
                            <label for="no_telepon" class="form-label required">No. Telepon</label>
                            <div class="input-group">
                                <span class="input-group-text">+62</span>
                                <input type="tel" class="form-control" id="no_telepon" name="no_telepon" placeholder="812xxx / Nomor WA" required>
                            </div>
                            <div class="form-text">Terkoneksi dengan WhatsApp</div>
                            <div class="invalid-feedback">Nomor telepon wajib diisi.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="no_darurat" class="form-label required">No. Telepon Darurat</label>
                            <div class="input-group">
                                <span class="input-group-text">+62</span>
                                <input type="tel" class="form-control" id="no_darurat" name="no_darurat" placeholder="0812xxx / Kerabat" required>
                            </div>
                            <div class="form-text">*No. Telepon Orang Tua / Kerabat</div>
                            <div class="invalid-feedback">Nomor telepon darurat wajib diisi.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="email" class="form-label required">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required placeholder="contoh@domain.com">
                            <div class="form-text">Pastikan Email Anda Valid</div>
                            <div class="invalid-feedback">Email wajib diisi dan format harus valid.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-4">
                            <label for="jenis_kelamin" class="form-label required">Jenis Kelamin</label>
                            <select class="form-select" id="jenis_kelamin" name="jenis_kelamin" required>
                                <option value="" disabled selected>Pilih...</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                            <div class="invalid-feedback">Jenis kelamin wajib dipilih.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="berat_badan" class="form-label required">Berat Badan (kg)</label>
                            <input type="number" class="form-control" id="berat_badan" name="berat_badan" min="1" required>
                            <div class="invalid-feedback">Berat badan wajib diisi.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="tinggi_badan" class="form-label required">Tinggi Badan (cm)</label>
                            <input type="number" class="form-control" id="tinggi_badan" name="tinggi_badan" min="1" required>
                            <div class="invalid-feedback">Tinggi badan wajib diisi.</div>
                        </div>
                    </div>

                    <p class="mt-4 fw-bold">Alamat (Sesuai KTP)</p>
                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <label for="provinsi" class="form-label required">Provinsi</label>
                            <select class="form-select" id="provinsi" name="provinsi" required>
                                <option value="" selected disabled>Memuat Provinsi...</option>
                            </select>
                            <div class="invalid-feedback">Provinsi wajib dipilih.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="kota" class="form-label required">Kota/Kabupaten</label>
                            <select class="form-select" id="kota" name="kota" required disabled>
                                <option value="" selected disabled>Pilih Kota/Kabupaten</option>
                            </select>
                            <div class="invalid-feedback">Kota/Kabupaten wajib dipilih.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <label for="kecamatan" class="form-label required">Kecamatan</label>
                            <select class="form-select" id="kecamatan" name="kecamatan" required disabled>
                                <option value="" selected disabled>Pilih Kecamatan</option>
                            </select>
                            <div class="invalid-feedback">Kecamatan wajib dipilih.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="kelurahan" class="form-label required">Kelurahan</label>
                            <select class="form-select" id="kelurahan" name="kelurahan" required disabled>
                                <option value="" selected disabled>Pilih Kelurahan</option>
                            </select>
                            <div class="invalid-feedback">Kelurahan wajib dipilih.</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="alamat" class="form-label required">Alamat Lengkap</label>
                        <textarea class="form-control" id="alamat" name="alamat" rows="2" required></textarea>
                        <div class="form-text">Isikan alamat sesuai dengan alamat pada KTP</div>
                        <div class="invalid-feedback">Alamat lengkap wajib diisi.</div>
                    </div>
                    
                    <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill flex-shrink-0 me-2" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34-.34.659-.58.88-.22.219-.47.38-.66.52A1 1 0 0 0 7 13h2a1 1 0 0 0 1-1V7.276a1.114 1.114 0 0 0-.256-.442c-.226-.25-.39-.425-.56-.605a.735.735 0 0 1-.22-.321c-.08-.25-.08-.49-.03-.708A.5.5 0 0 1 8 5a.5.5 0 0 1 .4.244z"/>
                        </svg>
                        <div>
                            Verifikasi pendaftaran akun akan ditutup pada Tanggal 20 Oktober 2025.
                        </div>
                    </div>

                    <div class="d-grid gap-2 col-md-4 mx-auto">
                        <button class="btn btn-warning submit-btn" type="submit">SUBMIT</button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // =======================================================================
        // A. VALIDASI BOOTSTRAP
        // =======================================================================
        (() => {
            'use strict'
            const forms = document.querySelectorAll('.needs-validation')
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        })()


        // =======================================================================
        // B. FIREBASE CONFIGURATIONS & SUBMIT HANDLER
        // =======================================================================

        // Import the functions you need from the SDKs you need
            import { initializeApp } from "firebase/app";
            import { getAnalytics } from "firebase/analytics";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
            apiKey: "AIzaSyBuDwtZP6hMWb1vzqztbVanRjTUQwJ7pxA",
            authDomain: "form-registrasi-89e90.firebaseapp.com",
            projectId: "form-registrasi-89e90",
            storageBucket: "form-registrasi-89e90.firebasestorage.app",
            messagingSenderId: "485535332255",
            appId: "1:485535332255:web:8f4c3b02733b5f0568efaa",
            measurementId: "G-20990GF34K"
};

        // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('form');
            const lampiranKtpInput = document.getElementById('lampiran_ktp');
            const submitButton = document.querySelector('.submit-btn');
            
            // Hapus listener untuk perbandingan password karena field sudah dihapus.

            form.addEventListener('submit', async function(event) {
                event.preventDefault(); 
                
                if (!form.checkValidity()) {
                    event.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Memproses & Mengunggah File...';

                try {
                    const ktpFile = lampiranKtpInput.files[0];

                    if (!ktpFile) {
                        alert("Mohon lampirkan file identitas.");
                        return; 
                    }

                    // --- UPLOAD KE FIREBASE STORAGE ---
                    const timestamp = new Date().getTime();
                    const fileName = `lampiran_identitas/${timestamp}_${ktpFile.name}`; 
                    const storageRef = storage.ref(fileName);

                    const uploadTask = storageRef.put(ktpFile);
                    const snapshot = await uploadTask;
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    // --- SIMPAN DATA TEKS KE FIRESTORE ---
                    const getSelectedText = (id) => document.getElementById(id).options[document.getElementById(id).selectedIndex].textContent;

                    const formData = {
                        kewarganegaraan: document.getElementById('kewarganengaraan').value,
                        jenis_identitas: document.getElementById('jenis_identitas').value,
                        nomor_ktp: document.getElementById('nomor_ktp').value,
                        nama_lengkap: document.getElementById('nama_lengkap').value,
                        tanggal_lahir: document.getElementById('tanggal_lahir').value,
                        no_telepon: document.getElementById('no_telepon').value,
                        no_darurat: document.getElementById('no_darurat').value,
                        email: document.getElementById('email').value,
                        jenis_kelamin: document.getElementById('jenis_kelamin').value,
                        berat_badan: document.getElementById('berat_badan').value,
                        tinggi_badan: document.getElementById('tinggi_badan').value,
                        
                        // Data alamat (mengambil nama/teks, bukan ID)
                        provinsi: getSelectedText('provinsi'),
                        kota: getSelectedText('kota'),
                        kecamatan: getSelectedText('kecamatan'),
                        kelurahan: getSelectedText('kelurahan'),

                        alamat_lengkap: document.getElementById('alamat').value,
                        
                        // Hapus field username, password dari formData
                        // username: document.getElementById('username').value, 
                        
                        // URL Foto dari Storage
                        url_lampiran_ktp: downloadURL, 
                        
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection("pendaftar_merbabu").add(formData);

                    alert("✅ Registrasi Berhasil! Data Anda dan lampiran telah tersimpan.");
                    form.reset(); 
                    form.classList.remove('was-validated');
                    resetNextDropdowns('kelurahan');
                } catch (error) {
                    console.error("Error saat menyimpan data: ", error);
                    alert("❌ Registrasi Gagal. Error: " + error.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'SUBMIT';
                }
            });
        });

        // =======================================================================
        // C. DINAMIKA DROPDOWN ALAMAT (API Panggilan) - (Kode ini sama seperti sebelumnya)
        // =======================================================================

        const selectProvinsi = document.getElementById('provinsi');
        const selectKota = document.getElementById('kota');
        const selectKecamatan = document.getElementById('kecamatan');
        const selectKelurahan = document.getElementById('kelurahan');

        const API_URL = 'https://www.emsifa.com/api-wilayah-indonesia/api/';

        function fillDropdown(selectElement, dataArray) {
            selectElement.innerHTML = `<option value="" selected disabled>Pilih ${selectElement.id.charAt(0).toUpperCase() + selectElement.id.slice(1)}</option>`;
            dataArray.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id || item.code; 
                option.textContent = item.name;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        }

        function resetNextDropdowns(currentLevel) {
            const levels = ['provinsi', 'kota', 'kecamatan', 'kelurahan'];
            const currentIndex = levels.indexOf(currentLevel);

            for (let i = currentIndex + 1; i < levels.length; i++) {
                const select = document.getElementById(levels[i]);
                select.innerHTML = `<option value="" selected disabled>Pilih ${levels[i].charAt(0).toUpperCase() + levels[i].slice(1)}</option>`;
                select.disabled = true;
            }
        }

        async function loadProvinsi() {
            try {
                const response = await fetch(API_URL + 'provinces.json');
                const data = await response.json();
                fillDropdown(selectProvinsi, data);
            } catch (error) {
                console.error('Gagal memuat Provinsi:', error);
                selectProvinsi.innerHTML = '<option value="" selected disabled>Gagal Memuat Data</option>';
            }
        }

        selectProvinsi.addEventListener('change', async function() {
            resetNextDropdowns('provinsi');
            selectKota.innerHTML = '<option value="" selected disabled>Memuat Kota...</option>';
            
            const idProvinsi = this.value;
            try {
                const response = await fetch(API_URL + `regencies/${idProvinsi}.json`);
                const data = await response.json();
                fillDropdown(selectKota, data);
            } catch (error) {
                console.error('Gagal memuat Kota:', error);
            }
        });

        selectKota.addEventListener('change', async function() {
            resetNextDropdowns('kota');
            selectKecamatan.innerHTML = '<option value="" selected disabled>Memuat Kecamatan...</option>';

            const idKota = this.value;
            try {
                const response = await fetch(API_URL + `districts/${idKota}.json`);
                const data = await response.json();
                fillDropdown(selectKecamatan, data);
            } catch (error) {
                console.error('Gagal memuat Kecamatan:', error);
            }
        });

        selectKecamatan.addEventListener('change', async function() {
            resetNextDropdowns('kecamatan');
            selectKelurahan.innerHTML = '<option value="" selected disabled>Memuat Kelurahan...</option>';

            const idKecamatan = this.value;
            try {
                const response = await fetch(API_URL + `villages/${idKecamatan}.json`);
                const data = await response.json();
                fillDropdown(selectKelurahan, data);
            } catch (error) {
                console.error('Gagal memuat Kelurahan:', error);
            }
        });
        
        loadProvinsi();
    </script>
</body>
</html>