<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrasi Akun Merbabu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="custom.css">
</head>
<body>

    <header class="bg-primary text-white py-4 mb-4">
        <div class="container text-center">
            <h1 class="fs-4">REGISTRASI MERBABU VIA WEKAS</h1>
            <p class="mb-0">OPEN TRIP GEMPAL !!!</p>
        </div>
    </header>

    <div class="container my-5">
        <div class="card shadow-lg border-0">
            <div class="card-body p-4 p-md-5">
                <form id="registrationForm" class="needs-validation" novalidate>

                    <div class="mb-4">
                        <label for="kewarganegaraan" class="form-label required">Jenis Kewarganegaraan</label>
                        <select class="form-select" id="kewarganegaraan" name="kewarganegaraan" required>
                            <option value="WNI" selected>WNI</option>
                            <option value="WNA">WNA</option>
                        </select>
                        <div class="invalid-feedback">Pilih jenis kewarganegaraan Anda.</div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-4">
                            <label for="jenis_identitas" class="form-label required">Jenis Identitas</label>
                            <select class="form-select" id="jenis_identitas" name="jenis_identitas" required>
                                <option value="KTP" selected>KTP</option>
                                <option value="Kartu Pelajar">Kartu Pelajar</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="lampiran_ktp" class="form-label required">Identitas KTP / Kartu Pelajar</label>
                            <input type="file" class="form-control" id="lampiran_ktp" name="lampiran_ktp" accept=".jpg,.png,.jpeg" required>
                            <div class="form-text">Silahkan lampirkan file gambar berformat .jpg / .png</div>
                            <div class="invalid-feedback">Lampiran identitas diperlukan.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="nomor_ktp" class="form-label required">Nomor KTP / Kartu Pelajar</label>
                            <input type="text" class="form-control" id="nomor_ktp" name="nomor_ktp" required pattern="\d{16}" placeholder="Masukkan 16 digit Nomor KTP / Nomor Kartu Pelajar">
                            <div class="invalid-feedback">Nomor KTP harus 16 digit angka.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <label for="nama_lengkap" class="form-label required">Nama Lengkap</label>
                            <input type="text" class="form-control" id="nama_lengkap" name="nama_lengkap" required>
                            <div class="invalid-feedback">Nama lengkap wajib diisi.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="tanggal_lahir" class="form-label required">Tanggal Lahir</label>
                            <input type="date" class="form-control" id="tanggal_lahir" name="tanggal_lahir" required>
                            <div class="invalid-feedback">Tanggal lahir wajib diisi.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-4">
                            <label for="no_telepon" class="form-label required">No. Telepon</label>
                            <div class="input-group">
                                <span class="input-group-text">+62</span>
                                <input type="tel" class="form-control" id="no_telepon" name="no_telepon" placeholder="812xxx / Nomor WA" required>
                            </div>
                            <div class="form-text">Terkoneksi dengan WhatsApp</div>
                            <div class="invalid-feedback">Nomor telepon wajib diisi.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="no_darurat" class="form-label required">No. Telepon Darurat</label>
                            <div class="input-group">
                                <span class="input-group-text">+62</span>
                                <input type="tel" class="form-control" id="no_darurat" name="no_darurat" placeholder="0812xxx / Kerabat" required>
                            </div>
                            <div class="form-text">*No. Telepon Orang Tua / Kerabat</div>
                            <div class="invalid-feedback">Nomor telepon darurat wajib diisi.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="email" class="form-label required">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required placeholder="contoh@domain.com">
                            <div class="form-text">Pastikan Email Anda Valid</div>
                            <div class="invalid-feedback">Email wajib diisi dan format harus valid.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-4">
                            <label for="jenis_kelamin" class="form-label required">Jenis Kelamin</label>
                            <select class="form-select" id="jenis_kelamin" name="jenis_kelamin" required>
                                <option value="" disabled selected>Pilih...</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                            <div class="invalid-feedback">Jenis kelamin wajib dipilih.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="berat_badan" class="form-label required">Berat Badan (kg)</label>
                            <input type="number" class="form-control" id="berat_badan" name="berat_badan" min="1" required>
                            <div class="invalid-feedback">Berat badan wajib diisi.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="tinggi_badan" class="form-label required">Tinggi Badan (cm)</label>
                            <input type="number" class="form-control" id="tinggi_badan" name="tinggi_badan" min="1" required>
                            <div class="invalid-feedback">Tinggi badan wajib diisi.</div>
                        </div>
                    </div>

                    <p class="mt-4 fw-bold">Alamat (Sesuai KTP)</p>
                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <label for="provinsi" class="form-label required">Provinsi</label>
                            <select class="form-select" id="provinsi" name="provinsi" required>
                                <option value="" selected disabled>Memuat Provinsi...</option>
                            </select>
                            <div class="invalid-feedback">Provinsi wajib dipilih.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="kota" class="form-label required">Kota/Kabupaten</label>
                            <select class="form-select" id="kota" name="kota" required disabled>
                                <option value="" selected disabled>Pilih Kota/Kabupaten</option>
                            </select>
                            <div class="invalid-feedback">Kota/Kabupaten wajib dipilih.</div>
                        </div>
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-md-6">
                            <label for="kecamatan" class="form-label required">Kecamatan</label>
                            <select class="form-select" id="kecamatan" name="kecamatan" required disabled>
                                <option value="" selected disabled>Pilih Kecamatan</option>
                            </select>
                            <div class="invalid-feedback">Kecamatan wajib dipilih.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="kelurahan" class="form-label required">Kelurahan</label>
                            <select class="form-select" id="kelurahan" name="kelurahan" required disabled>
                                <option value="" selected disabled>Pilih Kelurahan</option>
                            </select>
                            <div class="invalid-feedback">Kelurahan wajib dipilih.</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="alamat" class="form-label required">Alamat Lengkap</label>
                        <textarea class="form-control" id="alamat" name="alamat" rows="2" required></textarea>
                        <div class="form-text">Isikan alamat sesuai dengan alamat pada KTP</div>
                        <div class="invalid-feedback">Alamat lengkap wajib diisi.</div>
                    </div>
                    
                    <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle-fill flex-shrink-0 me-2" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34-.34.659-.58.88-.22.219-.47.38-.66.52A1 1 0 0 0 7 13h2a1 1 0 0 0 1-1V7.276a1.114 1.114 0 0 0-.256-.442c-.226-.25-.39-.425-.56-.605a.735.735 0 0 1-.22-.321c-.08-.25-.08-.49-.03-.708A.5.5 0 0 1 8 5a.5.5 0 0 1 .4.244z"/>
                        </svg>
                        <div>
                            Data yang Anda input menjadi TANGGUNG JAWAB Anda Sendiri dan Untuk Verifikasi pendaftaran akun akan ditutup pada Tanggal 20 Oktober 2025.
                        </div>
                    </div>

                    <div class="d-grid gap-2 col-md-4 mx-auto">
                        <button class="btn btn-warning submit-btn" type="submit">SUBMIT</button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // =======================================================================
        // A. VALIDASI BOOTSTRAP (TETAP SAMA)
        // =======================================================================
        (() => {
            'use strict'
            const form = document.getElementById('registrationForm');
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false);
        })()


        // =======================================================================
        // B. FIREBASE & CLOUDINARY CONFIGURATIONS & SUBMIT HANDLER (HYBRID)
        // =======================================================================

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBuDwtZP6hMWb1vzqztbVanRjTUQwJ7pxA", // GANTI DENGAN KUNCI ANDA
            authDomain: "form-registrasi-89e90.firebaseapp.com",
            projectId: "form-registrasi-89e90",
            // Tambahkan properti lain yang diperlukan
        };

        // --- KONFIGURASI CLOUDINARY (GANTI INI!) ---
        const CLOUDINARY_CLOUD_NAME = "dtigcegtl"; 
        const CLOUDINARY_UPLOAD_PRESET = "merbabu_unsigned"; 

        // Inisialisasi Firebase V8
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('registrationForm');
            const lampiranKtpInput = document.getElementById('lampiran_ktp');
            const submitButton = document.querySelector('.submit-btn');

            // Fungsi helper untuk mendapatkan teks dari dropdown yang dipilih
            const getSelectedText = (id) => {
                const selectElement = document.getElementById(id);
                // Menghindari error jika dropdown belum dipilih/diisi
                if (selectElement && selectElement.selectedIndex !== -1) {
                    return selectElement.options[selectElement.selectedIndex].textContent;
                }
                return ''; 
            };
            
            // -----------------------------------------------------------------------
            // FUNGSI UPLOAD KE CLOUDINARY
            // -----------------------------------------------------------------------
            async function uploadToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'merbabu_registrasi'); // Opsional: Untuk pengorganisasian

                const cloudinaryURL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;

                const response = await fetch(cloudinaryURL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Cloudinary Upload Gagal: ${errorData.error.message || response.statusText}`);
                }

                const data = await response.json();
                // Mengembalikan public_id Cloudinary yang akan disimpan di Firestore
                return data.public_id; 
            }


            // -----------------------------------------------------------------------
            // SUBMIT HANDLER BARU
            // -----------------------------------------------------------------------
            form.addEventListener('submit', async function(event) {
                // Mencegah submit default lagi (diulang karena validasi Bootstrap di atas)
                event.preventDefault(); 
                
                // Cek validasi ulang, walaupun sudah dilakukan oleh Bootstrap
                if (!form.checkValidity()) {
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Memproses & Mengunggah File...'; 

                try {
                    const ktpFile = lampiranKtpInput.files[0];

                    if (!ktpFile) {
                        throw new Error("Mohon lampirkan file identitas (KTP/Kartu Pelajar).");
                    }

                    // --- LANGKAH 1: UPLOAD KE CLOUDINARY ---
                    const cloudinaryId = await uploadToCloudinary(ktpFile);
                    submitButton.textContent = 'File Berhasil Diunggah. Menyimpan Data...';

                    // --- LANGKAH 2: SIMPAN DATA TEKS KE FIRESTORE ---
                    const formData = {
                        // Data Kredensial & Identitas
                        kewarganegaraan: document.getElementById('kewarganegaraan').value,
                        jenis_identitas: document.getElementById('jenis_identitas').value,
                        nomor_ktp: document.getElementById('nomor_ktp').value,
                        nama_lengkap: document.getElementById('nama_lengkap').value,
                        tanggal_lahir: document.getElementById('tanggal_lahir').value,
                        
                        // Data Kontak & Fisik
                        no_telepon: document.getElementById('no_telepon').value,
                        no_darurat: document.getElementById('no_darurat').value,
                        email: document.getElementById('email').value,
                        jenis_kelamin: document.getElementById('jenis_kelamin').value,
                        berat_badan: document.getElementById('berat_badan').value,
                        tinggi_badan: document.getElementById('tinggi_badan').value,
                        
                        // Data Alamat (Menggunakan Teks yang Dipilih dari Dropdown)
                        provinsi: getSelectedText('provinsi'),
                        kota: getSelectedText('kota'),
                        kecamatan: getSelectedText('kecamatan'),
                        kelurahan: getSelectedText('kelurahan'),
                        alamat_lengkap: document.getElementById('alamat').value,
                        
                        // LINK FOTO: Hanya simpan Public ID dari Cloudinary
                        cloudinary_public_id: cloudinaryId, 
                        
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection("pendaftar_merbabu").add(formData);

                    alert("✅ Registrasi Berhasil! Data Anda dan lampiran telah tersimpan.");
                    form.reset(); 
                    form.classList.remove('was-validated');
                    // Panggil fungsi resetNextDropdowns (dari bagian C)
                    resetNextDropdowns('kelurahan'); 

                } catch (error) {
                    console.error("Error saat submit: ", error);
                    alert("❌ Registrasi Gagal. Error: " + error.message);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'SUBMIT';
                }
            });
        });


        // =======================================================================
        // C. DINAMIKA DROPDOWN ALAMAT (API Panggilan - TIDAK BERUBAH)
        // =======================================================================

        const selectProvinsi = document.getElementById('provinsi');
        const selectKota = document.getElementById('kota');
        const selectKecamatan = document.getElementById('kecamatan');
        const selectKelurahan = document.getElementById('kelurahan');

        const API_URL = 'https://www.emsifa.com/api-wilayah-indonesia/api/';

        function fillDropdown(selectElement, dataArray) {
            selectElement.innerHTML = `<option value="" selected disabled>Pilih ${selectElement.id.charAt(0).toUpperCase() + selectElement.id.slice(1)}</option>`;
            dataArray.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id || item.code; 
                option.textContent = item.name;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        }

        function resetNextDropdowns(currentLevel) {
            const levels = ['provinsi', 'kota', 'kecamatan', 'kelurahan'];
            const currentIndex = levels.indexOf(currentLevel);

            for (let i = currentIndex + 1; i < levels.length; i++) {
                const select = document.getElementById(levels[i]);
                select.innerHTML = `<option value="" selected disabled>Pilih ${levels[i].charAt(0).toUpperCase() + levels[i].slice(1)}</option>`;
                select.disabled = true;
            }
        }

        async function loadProvinsi() {
            try {
                const response = await fetch(API_URL + 'provinces.json');
                const data = await response.json();
                fillDropdown(selectProvinsi, data);
            } catch (error) {
                console.error('Gagal memuat Provinsi:', error);
                selectProvinsi.innerHTML = '<option value="" selected disabled>Gagal Memuat Data</option>';
            }
        }

        selectProvinsi.addEventListener('change', async function() {
            resetNextDropdowns('provinsi');
            selectKota.innerHTML = '<option value="" selected disabled>Memuat Kota...</option>';
            
            const idProvinsi = this.value;
            try {
                const response = await fetch(API_URL + `regencies/${idProvinsi}.json`);
                const data = await response.json();
                fillDropdown(selectKota, data);
            } catch (error) {
                console.error('Gagal memuat Kota:', error);
            }
        });

        selectKota.addEventListener('change', async function() {
            resetNextDropdowns('kota');
            selectKecamatan.innerHTML = '<option value="" selected disabled>Memuat Kecamatan...</option>';

            const idKota = this.value;
            try {
                const response = await fetch(API_URL + `districts/${idKota}.json`);
                const data = await response.json();
                fillDropdown(selectKecamatan, data);
            } catch (error) {
                console.error('Gagal memuat Kecamatan:', error);
            }
        });

        selectKecamatan.addEventListener('change', async function() {
            resetNextDropdowns('kecamatan');
            selectKelurahan.innerHTML = '<option value="" selected disabled>Memuat Kelurahan...</option>';

            const idKecamatan = this.value;
            try {
                const response = await fetch(API_URL + `villages/${idKecamatan}.json`);
                const data = await response.json();
                fillDropdown(selectKelurahan, data);
            } catch (error) {
                console.error('Gagal memuat Kelurahan:', error);
            }
        });
        
        loadProvinsi();
    </script>
</body>
</html>